# Daily Movie Scraper - Parallel Edition
name: Daily Scrape

on:
  schedule:
    - cron: '0 23 * * *'  # 6 AM WIB
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8]
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      - name: Run scraper batch ${{ matrix.batch }}
        run: python -m backend.scrapers --schedules --batch ${{ matrix.batch }} --total-batches 9

      - name: Upload batch artifact
        uses: actions/upload-artifact@v4
        with:
          name: batch-${{ matrix.batch }}
          path: data/batch_*.json
          retention-days: 1

  merge:
    needs: scrape
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install google-cloud-firestore

      - name: Download all batch artifacts
        uses: actions/download-artifact@v4
        with:
          path: data/
          pattern: batch-*
          merge-multiple: true

      - name: Merge batches
        run: python -m backend.scrapers.merge_batches

      - name: Upload to Firestore
        run: python populate_firestore.py
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Commit data for web app
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f data/movies_*.json
          git commit -m "Daily scrape $(date +%Y-%m-%d)" || echo "No changes"
          git push

      - name: Upload final artifact
        uses: actions/upload-artifact@v4
        with:
          name: scrape-data-${{ github.run_id }}
          path: data/movies_*.json
          retention-days: 7
