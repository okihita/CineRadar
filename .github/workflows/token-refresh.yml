# Token Refresh Workflow
# Full Login via Playwright - runs every ~60 days or on manual trigger
# For daily scraping, use API refresh instead (see token_refresher.py)
name: Token Refresh

on:
  schedule:
    # 1st of every 2nd month @ 5:50 AM WIB (22:50 UTC previous day)
    - cron: '50 22 1 */2 *'
  workflow_dispatch:  # Manual trigger

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - uses: astral-sh/setup-uv@v7

      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          uv sync
          uv run playwright install chromium
          uv run playwright install-deps chromium
          sudo apt-get install -y xvfb

      - name: Refresh TIX.id token (with xvfb)
        id: refresh
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1280x720x24" \
            uv run python -m backend.cli.refresh_token
        env:
          TIX_PHONE_NUMBER: ${{ secrets.TIX_PHONE_NUMBER }}
          TIX_PASSWORD: ${{ secrets.TIX_PASSWORD }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Verify token stored
        if: success()
        run: uv run python -m backend.cli.refresh_token --check
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Alert on failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'ðŸš¨ Token Refresh Failed - Login Flow May Have Changed';
            const body = `## Token Refresh Workflow Failed
            
            **Run ID:** ${{ github.run_id }}
            **Time:** ${new Date().toISOString()}
            
            The Playwright-based login to TIX.id failed. This usually means:
            - The login page UI has changed (buttons moved, selectors changed)
            - TIX.id is temporarily down
            - Credentials are invalid
            
            **Action Required:**
            1. Check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Update \`backend/cli/refresh_token.py\` if selectors changed
            3. Re-run the workflow manually
            
            cc @${{ github.repository_owner }}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'token-refresh']
            });
